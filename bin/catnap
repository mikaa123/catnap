#!/usr/bin/env node

var express = require('express'),
	fs = require('fs'),
	server,
	app;

// Walk each folders to find *-resource.js files
var readdirp = require('readdirp');

var resources = [];
function restartServer() {
	server && server.close();
	app = express();

	// Catnap's facade
	GLOBAL.catnap = require('../lib/facade')(app);

	resources.forEach(function (resource) {
		require.cache[resource] && delete require.cache[resource];
		require(resource);
	});

	app.use(function(req, res, next) {
		res.send(404, 'Sorry cant find that!');
	});

	server = app.listen(3000, function () {
		console.log('Server running on port', 3000);
	});
}

var stream = readdirp({ root: process.cwd(), fileFilter: '*-resource.js' })
	.on('readable', function () {
		resources.push(stream.read().fullPath);
	})
	.on('end', function () {
		restartServer();
		resources.forEach(function (resource) {
			fs.watchFile(resource, function () {
				restartServer();
			});
		});
	});
